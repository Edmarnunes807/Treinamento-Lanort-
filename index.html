<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste API - Depuração</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #1e1e2e;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 25px;
            background: #7289da;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #5b73c4;
        }
        
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .error {
            color: #f44336;
        }
        
        .info {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Depuração da API</h1>
            <p>Testando conexão com sua API do Google Sheets</p>
        </header>
        
        <div class="panel">
            <h2>Teste de Conexão</h2>
            <button onclick="testAPI()">Testar API</button>
            <button onclick="testCORS()">Testar CORS</button>
            <button onclick="clearLog()">Limpar Log</button>
            
            <div id="status"></div>
            <pre id="log"></pre>
        </div>
        
        <div class="panel">
            <h2>Player de Vídeos (Se funcionar)</h2>
            <div id="videos-container"></div>
        </div>
    </div>

    <script>
        const apiUrl = 'https://script.google.com/macros/s/AKfycbzHoYUJ8INDFlmvd_BFkAh0SUCCBDEhs_nRIvb84VUgmzH9Q0X_S_Bgdmyc85CdVJrDqQ/exec';
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');
        const videosContainer = document.getElementById('videos-container');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] <span class="${type}">${message}</span>\n`;
            logElement.innerHTML += logEntry;
            console.log(message);
        }

        function clearLog() {
            logElement.innerHTML = '';
            statusElement.innerHTML = '';
        }

        async function testAPI() {
            clearLog();
            log('Iniciando teste da API...', 'info');
            
            try {
                log(`Fazendo requisição para: ${apiUrl}`, 'info');
                
                const startTime = Date.now();
                const response = await fetch(apiUrl);
                const endTime = Date.now();
                
                log(`Tempo de resposta: ${endTime - startTime}ms`, 'info');
                log(`Status HTTP: ${response.status}`, response.status === 200 ? 'success' : 'error');
                log(`OK: ${response.ok}`, response.ok ? 'success' : 'error');
                log(`Headers:`, 'info');
                
                // Log dos headers
                for (const [key, value] of response.headers.entries()) {
                    log(`  ${key}: ${value}`, 'info');
                }
                
                if (response.ok) {
                    const data = await response.text();
                    log('Resposta recebida (primeiros 500 caracteres):', 'success');
                    log(data.substring(0, 500), 'info');
                    
                    // Tentar parsear como JSON
                    try {
                        const jsonData = JSON.parse(data);
                        log('✅ Dados parseados com sucesso como JSON!', 'success');
                        displayVideos(jsonData);
                    } catch (e) {
                        log(`❌ Erro ao parsear JSON: ${e.message}`, 'error');
                        log('A resposta pode não estar em formato JSON válido', 'error');
                    }
                } else {
                    log(`❌ Erro na resposta: ${response.statusText}`, 'error');
                }
                
            } catch (error) {
                log(`❌ Erro na requisição: ${error.message}`, 'error');
                log(`Tipo do erro: ${error.name}`, 'error');
            }
        }

        async function testCORS() {
            clearLog();
            log('Testando CORS...', 'info');
            
            try {
                // Teste com modo 'no-cors' para ver se há bloqueio CORS
                const response = await fetch(apiUrl, { mode: 'no-cors' });
                log('✅ Requisição no-cors bem sucedida', 'success');
                log('Nota: O servidor pode estar bloqueando requisições CORS', 'info');
            } catch (error) {
                log(`❌ Erro CORS: ${error.message}`, 'error');
            }
        }

        function displayVideos(videos) {
            if (!videos || videos.length === 0) {
                videosContainer.innerHTML = '<p>Nenhum vídeo encontrado</p>';
                return;
            }

            let html = `<h3>Encontrados ${videos.length} itens:</h3>`;
            
            videos.forEach((video, index) => {
                // Extrair ID do Google Drive
                const driveUrl = video.url || '';
                let videoId = '';
                
                if (driveUrl.includes('/file/d/')) {
                    videoId = driveUrl.split('/file/d/')[1].split('/')[0];
                }
                
                const embedUrl = videoId ? 
                    `https://drive.google.com/file/d/${videoId}/preview` : 
                    driveUrl;

                html += `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 10px;">
                        <h4>${video.nome || 'Sem nome'}</h4>
                        <p><strong>Categoria:</strong> ${video.categoria || 'N/A'}</p>
                        <p><strong>Tipo:</strong> ${video.tipo || 'N/A'}</p>
                        <p><strong>URL:</strong> ${driveUrl || 'N/A'}</p>
                        ${embedUrl ? `
                            <div style="margin-top: 10px;">
                                <iframe src="${embedUrl}" width="100%" height="200" frameborder="0" allowfullscreen></iframe>
                                <br>
                                <a href="${embedUrl}" target="_blank" style="color: #7289da;">Abrir em nova aba</a>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            videosContainer.innerHTML = html;
        }

        // Testar automaticamente ao carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            log('Página carregada. Clique em "Testar API" para começar.', 'info');
        });
    </script>
</body>
</html>
